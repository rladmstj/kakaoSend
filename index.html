<!-- <!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Kakao Friends Message</title>
  <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
</head>
<body>
  <h1>카톡 친구에게 "안녕" 보내기</h1>
  <button id="login">카카오 로그인</button>
  <button id="friends">친구목록</button>
  <button id="send">"안녕" 보내기</button>
  <pre id="log"></pre>

  <script>
    // Kakao.init('👉여기에 자바스크립트 키');
     Kakao.init('fd68caed7a478deaea50b7a827bf5c3c');
    // fd68caed7a478deaea50b7a827bf5c3c
    console.log(Kakao.isInitialized());

    const log = m => document.getElementById('log').textContent += m + "\n";
    let selectedUuid = null;

    document.getElementById('login').onclick = () => {
      Kakao.Auth.login({
        scope: 'friends talk_message',
        success: res => log('로그인 OK ' + JSON.stringify(res)),
        fail: err => log('로그인 실패 ' + JSON.stringify(err))
      });
    };

    document.getElementById('friends').onclick = () => {
      Kakao.API.request({ url: '/v1/api/talk/friends' })
        .then(r => {
          log('친구목록 ' + JSON.stringify(r));
          selectedUuid = r.elements?.[0]?.uuid || null;
        })
        .catch(e => log('실패 ' + JSON.stringify(e)));
    };

    document.getElementById('send').onclick = () => {
      if (!selectedUuid) return alert("친구 먼저 선택");
      Kakao.API.request({
        url: '/v1/api/talk/friends/message/default/send',
        data: {
          receiver_uuids: [selectedUuid],
          template_object: {
            object_type: 'text',
            text: '안녕',
            link: { web_url: location.href }
          }
        }
      })
      .then(r => log('전송 OK ' + JSON.stringify(r)))
      .catch(e => log('전송 실패 ' + JSON.stringify(e)));
    };
  </script>
</body>
</html>
 -->
 <!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Kakao Friends Message</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
  <style>
    :root{
      --bg:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
      --card:#ffffff; --cardShadow:0 8px 24px rgba(0,0,0,.06);
      --brand:#2563eb; --brand-ink:#ffffff; --surface:#f8fafc;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; background:var(--surface); color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", sans-serif;
    }
    h1{margin:0 0 16px; font-size:22px; font-weight:800; letter-spacing:.2px}
    .wrap{max-width:1000px; margin:0 auto; display:grid; gap:16px}
    .row{display:grid; gap:16px}
    @media (min-width: 920px){ .row{grid-template-columns: 1.1fr 1fr} }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px;
      box-shadow: var(--cardShadow);
    }
    .title{font-weight:700; font-size:14px; margin-bottom:12px}
    .sub{font-size:12px; color:var(--muted)}

    button,input,textarea{font:inherit}
    button{
      padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer;
      transition:transform .05s ease, box-shadow .15s ease, border-color .15s ease;
    }
    button:hover{box-shadow:0 6px 14px rgba(0,0,0,.06)}
    button.primary{background:var(--brand); color:var(--brand-ink); border-color:var(--brand)}
    button:disabled{opacity:.6; cursor:not-allowed}

    input[type="text"], input[type="url"], textarea{
      width:100%; padding:12px 12px; border-radius:10px; border:1px solid var(--line); background:#fff;
    }
    .btns{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; color:var(--muted); font-size:12px}

    .grid{display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (min-width:720px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr))} }
    .friend{
      border:1px solid var(--line); border-radius:12px; padding:12px; background:#fff; display:grid; gap:10px; cursor:pointer;
      transition:border-color .15s ease, box-shadow .15s ease, transform .05s ease;
    }
    .friend:hover{box-shadow:0 6px 14px rgba(0,0,0,.06); transform:translateY(-1px)}
    .friend.selected{border-color:var(--brand); box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .avatar{width:64px; height:64px; border-radius:50%; background:#f3f4f6 center/cover no-repeat; border:1px solid var(--line)}
    .nick{font-weight:700}
    .uuid{font-size:12px; color:var(--muted); word-break:break-all}

    .row-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .log{white-space:pre-wrap; background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; max-height:220px; overflow:auto; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>카톡 친구에게 메시지 보내기</h1>

    <div class="row">
      <!-- 좌측 -->
      <div class="card">
        <div class="title">① 로그인 & 친구 가져오기</div>
        <div class="btns" style="margin-bottom:8px">
          <button id="loginBtn">카카오 로그인</button>
          <button id="logoutBtn">로그아웃</button>
          <span id="loginState" class="pill">로그인 안 됨</span>
        </div>
        <div class="btns" style="margin-bottom:8px">
          <button id="fetchFriendsBtn">친구목록 불러오기</button>
          <span class="sub">(* <b>friends, talk_message</b> 권한 필요 · 테스터만 조회 가능)</span>
        </div>

        <div id="friendsEmpty" class="sub" style="display:none; padding:8px 0;">표시할 친구가 없어요. (상대방이 로그인/권한 동의했는지 확인)</div>
        <div id="friendsGrid" class="grid"></div>
      </div>

      <!-- 우측 -->
      <div class="card">
        <div class="title">② 메시지 작성 & 전송</div>

        <label class="sub">보낼 대상</label>
        <input id="selectedFriendLabel" type="text" placeholder="아직 선택된 친구가 없습니다." readonly />

        <div style="height:12px"></div>
        <label class="sub">메시지 내용</label>
        <textarea id="messageInput" rows="4" placeholder="기본값: 안녕">안녕</textarea>

        <div style="height:12px"></div>
        <div class="row-actions">
          <label class="sub" style="display:inline-flex; align-items:center; gap:6px;">
            <input id="includeLink" type="checkbox" checked />
            링크 포함
          </label>
          <input id="linkInput" type="url" placeholder="링크 URL (비우면 현재 페이지 주소)" style="flex:1; min-width:220px;" />
        </div>

        <div style="height:14px"></div>
        <div class="btns">
          <button id="sendBtn" class="primary" disabled>메시지 보내기</button>
          <button id="clearBtn">입력 초기화</button>
        </div>
      </div>
    </div>

    <!-- 로그 -->
    <div class="card">
      <div class="title">로그</div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    // ✅ SDK 초기화 (자바스크립트 키)
    Kakao.init('fd68caed7a478deaea50b7a827bf5c3c');
    console.log('Kakao SDK initialized:', Kakao.isInitialized());

    const $ = id => document.getElementById(id);
    const log = (m, obj) => {
      const t = new Date().toLocaleTimeString();
      $('log').textContent += `[${t}] ${m}${obj ? ' ' + JSON.stringify(obj) : ''}\n`;
      $('log').scrollTop = $('log').scrollHeight;
    };

    let selectedFriend = null;
    let friends = [];

    function setLoginStateUI(){
      const token = Kakao.Auth.getAccessToken();
      $('loginState').textContent = token ? '로그인됨' : '로그인 안 됨';
    }

    function setSelectedFriend(f){
      selectedFriend = f;
      if(f){
        $('selectedFriendLabel').value = `${f.profile_nickname || '(이름 없음)'} (${f.uuid})`;
        $('sendBtn').disabled = false;
      }else{
        $('selectedFriendLabel').value = '';
        $('sendBtn').disabled = true;
      }
    }

    function renderFriends(list){
      const grid = $('friendsGrid');
      grid.innerHTML = '';
      if(!list || list.length === 0){
        $('friendsEmpty').style.display = 'block';
        setSelectedFriend(null);
        return;
      }
      $('friendsEmpty').style.display = 'none';

      list.forEach(f=>{
        const card = document.createElement('div');
        card.className = 'friend';
        card.dataset.uuid = f.uuid;

        const row = document.createElement('div');
        row.style.display = 'flex'; row.style.gap = '12px'; row.style.alignItems = 'center';

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        if(f.profile_thumbnail_image) avatar.style.backgroundImage = `url(${f.profile_thumbnail_image})`;

        const info = document.createElement('div');
        info.style.display = 'grid'; info.style.gap = '2px';
        const nick = document.createElement('div'); nick.className = 'nick'; nick.textContent = f.profile_nickname || '(이름 없음)';
        const uuid = document.createElement('div'); uuid.className = 'uuid'; uuid.textContent = f.uuid;
        info.appendChild(nick); info.appendChild(uuid);

        row.appendChild(avatar); row.appendChild(info);
        card.appendChild(row);

        card.addEventListener('click', ()=>{
          setSelectedFriend(f);
          [...grid.children].forEach(el=>el.classList.remove('selected'));
          card.classList.add('selected');
        });

        grid.appendChild(card);
      });
    }

    // 이벤트
    $('loginBtn').onclick = ()=>{
      Kakao.Auth.login({
        scope: 'friends talk_message',
        success: res=>{ log('로그인 성공', res); setLoginStateUI(); },
        fail: err=> log('로그인 실패', err)
      });
    };
    $('logoutBtn').onclick = ()=>{
      Kakao.Auth.logout(()=>{ log('로그아웃 완료'); setLoginStateUI(); renderFriends([]); });
    };
    $('fetchFriendsBtn').onclick = async ()=>{
      try{
        const r = await Kakao.API.request({ url: '/v1/api/talk/friends' });
        friends = r?.elements ?? [];
        log('친구목록', { total: friends.length });
        renderFriends(friends);
      }catch(e){ log('친구목록 실패', e); }
    };
    $('clearBtn').onclick = ()=>{
      $('messageInput').value = '안녕';
      $('includeLink').checked = true;
      $('linkInput').value = '';
      log('입력 초기화');
    };
    $('sendBtn').onclick = async ()=>{
      if(!selectedFriend) return alert('친구를 먼저 선택하세요.');
      const text = ($('messageInput').value || '').trim() || '안녕';
      const includeLink = $('includeLink').checked;
      const linkUrl = ($('linkInput').value || '').trim() || location.href;

      const template_object = {
        object_type: 'text',
        text,
        link: includeLink
          ? { web_url: linkUrl, mobile_web_url: linkUrl }
          : { web_url: location.href, mobile_web_url: location.href },
        button_title: '열어보기'
      };

      try{
        const r = await Kakao.API.request({
          url:'/v1/api/talk/friends/message/default/send',
          data:{ receiver_uuids: [selectedFriend.uuid], template_object }
        });
        log('전송 성공', r);
      }catch(e){ log('전송 실패', e); }
    };

    setLoginStateUI();
   
// === 도우미들 ===
const sleep = ms => new Promise(r => setTimeout(r, ms));
const chunk = (arr, n) => Array.from({length: Math.ceil(arr.length/n)}, (_,i)=>arr.slice(i*n,(i+1)*n));
const MAX_PER_REQ = 5; // 카카오: 한 요청당 최대 5명

function ensureLoginOrFail(){
  const token = Kakao.Auth.getAccessToken();
  if(!token) { alert('카카오 로그인이 필요합니다.'); throw new Error('not_logged_in'); }
}

async function sendToUuids(uuids, text, link){
  ensureLoginOrFail();
  const template_object = {
    object_type: 'text',
    text: (text || '이전 설문에 참여하지 않았습니다. 다음 알림에 참여해주세요.').slice(0, 900),
    link: link ? { web_url: link, mobile_web_url: link } : undefined,
    button_title: '열어보기'
  };

  const batches = chunk(uuids.filter(Boolean), MAX_PER_REQ);
  const results = [];
  for(const group of batches){
    try{
      const r = await Kakao.API.request({
        url: '/v1/api/talk/friends/message/default/send',
        data: { receiver_uuids: group, template_object }
      });
      results.push({ ok:true, group, r });
      await sleep(400); // 너무 빠른 연속 호출 방지
    }catch(e){
      results.push({ ok:false, group, error: e });
      await sleep(400);
    }
  }
  return results;
}

// === 다른 사이트에서 오는 postMessage 수신 (오리진 검사 없음) ===
window.addEventListener('message', async (event) => {
  const { type, payload } = event.data || {};
  if(type !== 'KAKAO_BULK_SEND') return;

  try{
    const uuids = Array.isArray(payload?.uuids) ? payload.uuids : [];
    if(uuids.length === 0) throw new Error('uuids 가 비어 있습니다.');
    const text = payload?.text;
    const link = payload?.link;

    const results = await sendToUuids(uuids, text, link);
    event.source?.postMessage({ type: 'KAKAO_BULK_SEND_DONE', results }, event.origin);
  }catch(err){
    event.source?.postMessage({ type: 'KAKAO_BULK_SEND_DONE', error: String(err) }, event.origin);
  }
});
 

  </script>
</body>
</html>
