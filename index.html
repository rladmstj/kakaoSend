<!-- <!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Kakao Friends Message</title>
  <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
</head>
<body>
  <h1>ì¹´í†¡ ì¹œêµ¬ì—ê²Œ "ì•ˆë…•" ë³´ë‚´ê¸°</h1>
  <button id="login">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</button>
  <button id="friends">ì¹œêµ¬ëª©ë¡</button>
  <button id="send">"ì•ˆë…•" ë³´ë‚´ê¸°</button>
  <pre id="log"></pre>

  <script>
    // Kakao.init('ğŸ‘‰ì—¬ê¸°ì— ìë°”ìŠ¤í¬ë¦½íŠ¸ í‚¤');
     Kakao.init('fd68caed7a478deaea50b7a827bf5c3c');
    // fd68caed7a478deaea50b7a827bf5c3c
    console.log(Kakao.isInitialized());

    const log = m => document.getElementById('log').textContent += m + "\n";
    let selectedUuid = null;

    document.getElementById('login').onclick = () => {
      Kakao.Auth.login({
        scope: 'friends talk_message',
        success: res => log('ë¡œê·¸ì¸ OK ' + JSON.stringify(res)),
        fail: err => log('ë¡œê·¸ì¸ ì‹¤íŒ¨ ' + JSON.stringify(err))
      });
    };

    document.getElementById('friends').onclick = () => {
      Kakao.API.request({ url: '/v1/api/talk/friends' })
        .then(r => {
          log('ì¹œêµ¬ëª©ë¡ ' + JSON.stringify(r));
          selectedUuid = r.elements?.[0]?.uuid || null;
        })
        .catch(e => log('ì‹¤íŒ¨ ' + JSON.stringify(e)));
    };

    document.getElementById('send').onclick = () => {
      if (!selectedUuid) return alert("ì¹œêµ¬ ë¨¼ì € ì„ íƒ");
      Kakao.API.request({
        url: '/v1/api/talk/friends/message/default/send',
        data: {
          receiver_uuids: [selectedUuid],
          template_object: {
            object_type: 'text',
            text: 'ì•ˆë…•',
            link: { web_url: location.href }
          }
        }
      })
      .then(r => log('ì „ì†¡ OK ' + JSON.stringify(r)))
      .catch(e => log('ì „ì†¡ ì‹¤íŒ¨ ' + JSON.stringify(e)));
    };
  </script>
</body>
</html>
 -->
 <!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Kakao Friends Message</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
  <style>
    :root{
      --bg:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
      --card:#ffffff; --cardShadow:0 8px 24px rgba(0,0,0,.06);
      --brand:#2563eb; --brand-ink:#ffffff; --surface:#f8fafc;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; background:var(--surface); color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", sans-serif;
    }
    h1{margin:0 0 16px; font-size:22px; font-weight:800; letter-spacing:.2px}
    .wrap{max-width:1000px; margin:0 auto; display:grid; gap:16px}
    .row{display:grid; gap:16px}
    @media (min-width: 920px){ .row{grid-template-columns: 1.1fr 1fr} }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px;
      box-shadow: var(--cardShadow);
    }
    .title{font-weight:700; font-size:14px; margin-bottom:12px}
    .sub{font-size:12px; color:var(--muted)}

    button,input,textarea{font:inherit}
    button{
      padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer;
      transition:transform .05s ease, box-shadow .15s ease, border-color .15s ease;
    }
    button:hover{box-shadow:0 6px 14px rgba(0,0,0,.06)}
    button.primary{background:var(--brand); color:var(--brand-ink); border-color:var(--brand)}
    button:disabled{opacity:.6; cursor:not-allowed}

    input[type="text"], input[type="url"], textarea{
      width:100%; padding:12px 12px; border-radius:10px; border:1px solid var(--line); background:#fff;
    }
    .btns{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; color:var(--muted); font-size:12px}

    .grid{display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (min-width:720px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr))} }
    .friend{
      border:1px solid var(--line); border-radius:12px; padding:12px; background:#fff; display:grid; gap:10px; cursor:pointer;
      transition:border-color .15s ease, box-shadow .15s ease, transform .05s ease;
    }
    .friend:hover{box-shadow:0 6px 14px rgba(0,0,0,.06); transform:translateY(-1px)}
    .friend.selected{border-color:var(--brand); box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .avatar{width:64px; height:64px; border-radius:50%; background:#f3f4f6 center/cover no-repeat; border:1px solid var(--line)}
    .nick{font-weight:700}
    .uuid{font-size:12px; color:var(--muted); word-break:break-all}

    .row-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .log{white-space:pre-wrap; background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; max-height:220px; overflow:auto; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ì¹´í†¡ ì¹œêµ¬ì—ê²Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°</h1>

    <div class="row">
      <!-- ì¢Œì¸¡ -->
      <div class="card">
        <div class="title">â‘  ë¡œê·¸ì¸ & ì¹œêµ¬ ê°€ì ¸ì˜¤ê¸°</div>
        <div class="btns" style="margin-bottom:8px">
          <button id="loginBtn">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</button>
          <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
          <span id="loginState" class="pill">ë¡œê·¸ì¸ ì•ˆ ë¨</span>
        </div>
        <div class="btns" style="margin-bottom:8px">
          <button id="fetchFriendsBtn">ì¹œêµ¬ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <span class="sub">(* <b>friends, talk_message</b> ê¶Œí•œ í•„ìš” Â· í…ŒìŠ¤í„°ë§Œ ì¡°íšŒ ê°€ëŠ¥)</span>
        </div>

        <div id="friendsEmpty" class="sub" style="display:none; padding:8px 0;">í‘œì‹œí•  ì¹œêµ¬ê°€ ì—†ì–´ìš”. (ìƒëŒ€ë°©ì´ ë¡œê·¸ì¸/ê¶Œí•œ ë™ì˜í–ˆëŠ”ì§€ í™•ì¸)</div>
        <div id="friendsGrid" class="grid"></div>
      </div>

      <!-- ìš°ì¸¡ -->
      <div class="card">
        <div class="title">â‘¡ ë©”ì‹œì§€ ì‘ì„± & ì „ì†¡</div>

        <label class="sub">ë³´ë‚¼ ëŒ€ìƒ</label>
        <input id="selectedFriendLabel" type="text" placeholder="ì•„ì§ ì„ íƒëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤." readonly />

        <div style="height:12px"></div>
        <label class="sub">ë©”ì‹œì§€ ë‚´ìš©</label>
        <textarea id="messageInput" rows="4" placeholder="ê¸°ë³¸ê°’: ì•ˆë…•">ì•ˆë…•</textarea>

        <div style="height:12px"></div>
        <div class="row-actions">
          <label class="sub" style="display:inline-flex; align-items:center; gap:6px;">
            <input id="includeLink" type="checkbox" checked />
            ë§í¬ í¬í•¨
          </label>
          <input id="linkInput" type="url" placeholder="ë§í¬ URL (ë¹„ìš°ë©´ í˜„ì¬ í˜ì´ì§€ ì£¼ì†Œ)" style="flex:1; min-width:220px;" />
        </div>

        <div style="height:14px"></div>
        <div class="btns">
          <button id="sendBtn" class="primary" disabled>ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
          <button id="clearBtn">ì…ë ¥ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>

    <!-- ë¡œê·¸ -->
    <div class="card">
      <div class="title">ë¡œê·¸</div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    // âœ… SDK ì´ˆê¸°í™” (ìë°”ìŠ¤í¬ë¦½íŠ¸ í‚¤)
    Kakao.init('fd68caed7a478deaea50b7a827bf5c3c');
    console.log('Kakao SDK initialized:', Kakao.isInitialized());

    const $ = id => document.getElementById(id);
    const log = (m, obj) => {
      const t = new Date().toLocaleTimeString();
      $('log').textContent += `[${t}] ${m}${obj ? ' ' + JSON.stringify(obj) : ''}\n`;
      $('log').scrollTop = $('log').scrollHeight;
    };

    let selectedFriend = null;
    let friends = [];

    function setLoginStateUI(){
      const token = Kakao.Auth.getAccessToken();
      $('loginState').textContent = token ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì¸ ì•ˆ ë¨';
    }

    function setSelectedFriend(f){
      selectedFriend = f;
      if(f){
        $('selectedFriendLabel').value = `${f.profile_nickname || '(ì´ë¦„ ì—†ìŒ)'} (${f.uuid})`;
        $('sendBtn').disabled = false;
      }else{
        $('selectedFriendLabel').value = '';
        $('sendBtn').disabled = true;
      }
    }

    function renderFriends(list){
      const grid = $('friendsGrid');
      grid.innerHTML = '';
      if(!list || list.length === 0){
        $('friendsEmpty').style.display = 'block';
        setSelectedFriend(null);
        return;
      }
      $('friendsEmpty').style.display = 'none';

      list.forEach(f=>{
        const card = document.createElement('div');
        card.className = 'friend';
        card.dataset.uuid = f.uuid;

        const row = document.createElement('div');
        row.style.display = 'flex'; row.style.gap = '12px'; row.style.alignItems = 'center';

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        if(f.profile_thumbnail_image) avatar.style.backgroundImage = `url(${f.profile_thumbnail_image})`;

        const info = document.createElement('div');
        info.style.display = 'grid'; info.style.gap = '2px';
        const nick = document.createElement('div'); nick.className = 'nick'; nick.textContent = f.profile_nickname || '(ì´ë¦„ ì—†ìŒ)';
        const uuid = document.createElement('div'); uuid.className = 'uuid'; uuid.textContent = f.uuid;
        info.appendChild(nick); info.appendChild(uuid);

        row.appendChild(avatar); row.appendChild(info);
        card.appendChild(row);

        card.addEventListener('click', ()=>{
          setSelectedFriend(f);
          [...grid.children].forEach(el=>el.classList.remove('selected'));
          card.classList.add('selected');
        });

        grid.appendChild(card);
      });
    }

    // ì´ë²¤íŠ¸
    $('loginBtn').onclick = ()=>{
      Kakao.Auth.login({
        scope: 'friends talk_message',
        success: res=>{ log('ë¡œê·¸ì¸ ì„±ê³µ', res); setLoginStateUI(); },
        fail: err=> log('ë¡œê·¸ì¸ ì‹¤íŒ¨', err)
      });
    };
    $('logoutBtn').onclick = ()=>{
      Kakao.Auth.logout(()=>{ log('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ'); setLoginStateUI(); renderFriends([]); });
    };
    $('fetchFriendsBtn').onclick = async ()=>{
      try{
        const r = await Kakao.API.request({ url: '/v1/api/talk/friends' });
        friends = r?.elements ?? [];
        log('ì¹œêµ¬ëª©ë¡', { total: friends.length });
        renderFriends(friends);
      }catch(e){ log('ì¹œêµ¬ëª©ë¡ ì‹¤íŒ¨', e); }
    };
    $('clearBtn').onclick = ()=>{
      $('messageInput').value = 'ì•ˆë…•';
      $('includeLink').checked = true;
      $('linkInput').value = '';
      log('ì…ë ¥ ì´ˆê¸°í™”');
    };
    $('sendBtn').onclick = async ()=>{
      if(!selectedFriend) return alert('ì¹œêµ¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
      const text = ($('messageInput').value || '').trim() || 'ì•ˆë…•';
      const includeLink = $('includeLink').checked;
      const linkUrl = ($('linkInput').value || '').trim() || location.href;

      const template_object = {
        object_type: 'text',
        text,
        link: includeLink
          ? { web_url: linkUrl, mobile_web_url: linkUrl }
          : { web_url: location.href, mobile_web_url: location.href },
        button_title: 'ì—´ì–´ë³´ê¸°'
      };

      try{
        const r = await Kakao.API.request({
          url:'/v1/api/talk/friends/message/default/send',
          data:{ receiver_uuids: [selectedFriend.uuid], template_object }
        });
        log('ì „ì†¡ ì„±ê³µ', r);
      }catch(e){ log('ì „ì†¡ ì‹¤íŒ¨', e); }
    };

    setLoginStateUI();
   
// === ë„ìš°ë¯¸ë“¤ ===
const sleep = ms => new Promise(r => setTimeout(r, ms));
const chunk = (arr, n) => Array.from({length: Math.ceil(arr.length/n)}, (_,i)=>arr.slice(i*n,(i+1)*n));
const MAX_PER_REQ = 5; // ì¹´ì¹´ì˜¤: í•œ ìš”ì²­ë‹¹ ìµœëŒ€ 5ëª…

function ensureLoginOrFail(){
  const token = Kakao.Auth.getAccessToken();
  if(!token) { alert('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); throw new Error('not_logged_in'); }
}

async function sendToUuids(uuids, text, link){
  ensureLoginOrFail();
  const template_object = {
    object_type: 'text',
    text: (text || 'ì´ì „ ì„¤ë¬¸ì— ì°¸ì—¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ìŒ ì•Œë¦¼ì— ì°¸ì—¬í•´ì£¼ì„¸ìš”.').slice(0, 900),
    link: link ? { web_url: link, mobile_web_url: link } : undefined,
    button_title: 'ì—´ì–´ë³´ê¸°'
  };

  const batches = chunk(uuids.filter(Boolean), MAX_PER_REQ);
  const results = [];
  for(const group of batches){
    try{
      const r = await Kakao.API.request({
        url: '/v1/api/talk/friends/message/default/send',
        data: { receiver_uuids: group, template_object }
      });
      results.push({ ok:true, group, r });
      await sleep(400); // ë„ˆë¬´ ë¹ ë¥¸ ì—°ì† í˜¸ì¶œ ë°©ì§€
    }catch(e){
      results.push({ ok:false, group, error: e });
      await sleep(400);
    }
  }
  return results;
}

// === ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œ ì˜¤ëŠ” postMessage ìˆ˜ì‹  (ì˜¤ë¦¬ì§„ ê²€ì‚¬ ì—†ìŒ) ===
window.addEventListener('message', async (event) => {
  const { type, payload } = event.data || {};
  if(type !== 'KAKAO_BULK_SEND') return;

  try{
    const uuids = Array.isArray(payload?.uuids) ? payload.uuids : [];
    if(uuids.length === 0) throw new Error('uuids ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
    const text = payload?.text;
    const link = payload?.link;

    const results = await sendToUuids(uuids, text, link);
    event.source?.postMessage({ type: 'KAKAO_BULK_SEND_DONE', results }, event.origin);
  }catch(err){
    event.source?.postMessage({ type: 'KAKAO_BULK_SEND_DONE', error: String(err) }, event.origin);
  }
});
 

  </script>
</body>
</html>
